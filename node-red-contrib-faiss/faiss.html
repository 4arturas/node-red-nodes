<script type="text/javascript">
    RED.nodes.registerType('faiss-store', {
        category: 'rag',
        color: '#E6E0F8',
        defaults: {
            name: { value: "" },
            operation: { value: "add", required: true },
            persistPath: { value: "./faiss_index" },
            k: { value: 5, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-database",
        label: function() {
            return this.name || "faiss-store";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>

<script type="text/html" data-template-name="faiss-store">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-operation"><i class="fa fa-cog"></i> Operation</label>
        <select id="node-input-operation" style="width: 70%;">
            <option value="add">Add documents</option>
            <option value="search">Similarity search</option>
            <option value="save">Save index</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-persistPath"><i class="fa fa-folder"></i> Persist Path</label>
        <input type="text" id="node-input-persistPath" placeholder="./faiss_index">
    </div>
    <div class="form-row" id="kRow">
        <label for="node-input-k"><i class="fa fa-search"></i> K (results)</label>
        <input type="number" id="node-input-k" placeholder="5" min="1" max="100">
    </div>
</script>

<script type="text/html" data-help-name="faiss-store">
    <p>FAISS vector store for local similarity search. No server required - stores embeddings on disk.</p>
    
    <h3>Operations</h3>
    
    <h4>Add Documents</h4>
    <p>Add documents with embeddings to the FAISS index:</p>
    <dl class="message-properties">
        <dt>msg.embeddings</dt>
        <dd>Embeddings instance from Ollama Embeddings node</dd>
        <dt>msg.documents</dt>
        <dd>Array of documents with pageContent and metadata (optional)</dd>
        <dt>msg.payload</dt>
        <dd>Text content (if msg.documents not provided)</dd>
    </dl>
    
    <h4>Similarity Search</h4>
    <p>Search for similar documents using a query embedding:</p>
    <dl class="message-properties">
        <dt>msg.payload</dt>
        <dd>Query embedding vector (array of numbers)</dd>
    </dl>
    
    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Operation <span class="property-type">string</span></dt>
        <dd>Operation mode: <code>add</code>, <code>search</code>, or <code>save</code></dd>
        
        <dt>Persist Path <span class="property-type">string</span></dt>
        <dd>Directory path to save/load FAISS index (default: <code>./faiss_index</code>)</dd>
        
        <dt>K <span class="property-type">number</span></dt>
        <dd>Number of results to return for similarity search (default: 5)</dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg.payload <span class="property-type">string|array</span></dt>
        <dd>Status message (add/save) or array of search results with scores</dd>
        <dt class="optional">msg.searchResults <span class="property-type">array</span></dt>
        <dd>Search results with pageContent, metadata, and score</dd>
    </dl>
    
    <h3>Example: RAG Indexing</h3>
    <pre><code>[Text Chunk] → [Ollama Embeddings] → [FAISS Store (add)]</code></pre>
    
    <h3>Example: RAG Retrieval</h3>
    <pre><code>[Query] → [Ollama Embeddings] → [FAISS Store (search)] → [ChatOllama]</code></pre>
    
    <h3>Notes</h3>
    <ul>
        <li>FAISS index is automatically saved after adding documents</li>
        <li>Index is automatically loaded on first search if it exists</li>
        <li>No Docker or external server required</li>
    </ul>
</script>

<style>
    #kRow { display: none; }
</style>

<script>
    $('#node-input-operation').on('change', function() {
        if (this.value === 'search') {
            $('#kRow').show();
        } else {
            $('#kRow').hide();
        }
    });
    
    $(document).ready(function() {
        if ($('#node-input-operation').val() === 'search') {
            $('#kRow').show();
        }
    });
</script>
